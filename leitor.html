<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Flipbook de PDF</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/page-flip/dist/page-flip.browser.min.css">
    <style>
        html, body { margin:0;padding:0;height:100%;width:100%;background:#222;overflow:hidden; }
        #flipbook { position:fixed;top:0;left:0;width:100vw;height:100vh; }
        #carregando { position:fixed;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;color:#fff;background:#222;font-size:2em;z-index:10;}
        .page-btns { position:fixed;bottom:2vh;left:50%;transform:translateX(-50%);display:flex;gap:1.5em;z-index:20;}
        .page-btns button, .page-btns input[type=range] { background:#fff2;color:#fff;border:none;border-radius:6px;padding:0.7em 1.4em;font-size:1.3em;cursor:pointer;transition:background .2s;}
        .page-btns button:hover { background: #67aec8; }
        .fullscreen-btn { position:fixed;top:2vh;right:2vw;z-index:30;background:#fff2;color:#fff;border:none;border-radius:6px;padding:0.7em 1.1em;font-size:1.1em;cursor:pointer;transition:background .2s;}
        .fullscreen-btn:hover { background: #67aec8; }
    </style>
</head>
<body>
    <div id="carregando">Carregando p√°ginas...</div>
    <div id="flipbook"></div>
    <div class="page-btns" style="display:none;">
        <button id="prev-page">‚ü®</button>
        <input type="range" id="page-slider" min="1" max="2" value="1" style="width:120px;">
        <button id="next-page">‚ü©</button>
    </div>
    <button class="fullscreen-btn" id="toggle-full">üóñ Tela Cheia</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <!-- USAR AQUI O UNPKG -->
    <script src="https://unpkg.com/page-flip/dist/page-flip.browser.min.js"></script>
    <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    function getQueryParam(nome) {
        const params = new URLSearchParams(window.location.search);
        return params.get(nome) || '';
    }
    const arquivo = getQueryParam('file') ||
      "https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf";
    const titulo = getQueryParam('nome');
    document.title = titulo ? titulo + " ‚Äì Flipbook" : "Flipbook de PDF";
    if (!arquivo) {
        document.getElementById('carregando').textContent = 'PDF n√£o encontrado.';
        throw new Error('PDF n√£o encontrado');
    }

    async function renderFlipbook(pdfUrl) {
        try {
            const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
            const numPages = pdf.numPages;
            const pageImages = [];
            for (let i = 1; i <= numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.3 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const context = canvas.getContext('2d');
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                pageImages.push(canvas.toDataURL('image/png'));
                document.getElementById('carregando').textContent = `Carregando p√°gina ${i} de ${numPages}...`;
            }
            document.getElementById('carregando').style.display = 'none';

            // AGORA FUNCIONA: PageFlip
            const flip = new PageFlip(document.getElementById('flipbook'), {
                width: Math.min(700, window.innerWidth*0.95),
                height: Math.min(980, window.innerHeight*0.93),
                size: 'stretch',
                maxShadowOpacity: 0.6,
                showCover: false,
                mobileScrollSupport: true
            });
            const flipPages = pageImages.map(src => ({ src }));
            flip.loadFromImages(flipPages);

            const btns = document.querySelector('.page-btns');
            btns.style.display = 'flex';
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            const slider = document.getElementById('page-slider');
            slider.max = flipPages.length;
            slider.value = 1;

            prevBtn.onclick = () => flip.flipPrev();
            nextBtn.onclick = () => flip.flipNext();
            slider.oninput = e => flip.flipToPage(Number(slider.value)-1);
            flip.on('flip', e => { slider.value = e.data + 1; });

            const fullBtn = document.getElementById('toggle-full');
            fullBtn.onclick = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    fullBtn.textContent = 'üóó Sair da Tela Cheia';
                } else {
                    document.exitFullscreen();
                    fullBtn.textContent = 'üóñ Tela Cheia';
                }
            };
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement)
                    fullBtn.textContent = 'üóñ Tela Cheia';
            });
            window.addEventListener('resize', () => {
                flip.update({
                    width: Math.min(700, window.innerWidth*0.95),
                    height: Math.min(980, window.innerHeight*0.93)
                });
            });
        } catch (e) {
            document.getElementById('carregando').textContent = 'Erro ao carregar o PDF. ' + e;
            console.error(e);
        }
    }
    renderFlipbook(arquivo);
    </script>
</body>
</html>